name: dbt CI/CD Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  dbt-ci:
    name: dbt CI Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.9'
       
      - name: Install dbt
        run: pip install dbt-core dbt-bigquery
          
      - name: Install dbt dependencies
        run: dbt deps
        continue-on-error: true
      
      - name: Parse dbt project
        run: dbt parse --profiles-dir ./
        continue-on-error: false
      
      - name: Compile dbt models
        run: dbt compile --profiles-dir ./
        continue-on-error: false
      
      - name: List dbt models
        run: dbt ls --profiles-dir ./
        continue-on-error: true
      
      - name: Generate dbt docs
        run: dbt docs generate --profiles-dir ./
        continue-on-error: true

      - name: CI Summary
        run: |
          echo "✓ dbt project parsed successfully"
          echo "✓ All models compiled successfully"
          echo "✓ CI checks passed!"
  
  dbt-deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: dbt-ci
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.9'
      
      - name: Install dbt
        run: pip install dbt-core dbt-bigquery
      
      - name: Install dependencies
        run: dbt deps
        continue-on-error: true
      
      # Create service account keyfile from secret
      - name: Setup BigQuery credentials
        run: |
          echo '${{ secrets.DEV_DBT_KEYFILE_JSON }}' > keyfile.json
          export GOOGLE_APPLICATION_CREDENTIALS=keyfile.json
      
      - name: Deploy to Dev Environment
        run: dbt run --target dev --profiles-dir ./
        env:
          DBT_PROJECT: ${{ secrets.DEV_DBT_PROJECT }}
          DBT_DATASET: ${{ secrets.DEV_DBT_DATASET }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.KEYFILE_JSON }}
      
      - name: Run Tests in Dev
        run: dbt test --target dev --profiles-dir ./
        env:
          DBT_PROJECT: ${{ secrets.DEV_DBT_PROJECT }}
          DBT_DATASET: ${{ secrets.DEV_DBT_DATASET }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.KEYFILE_JSON }}
      
      - name: Deployment Summary
        run: echo "✓ Successfully deployed to DEV environment!"